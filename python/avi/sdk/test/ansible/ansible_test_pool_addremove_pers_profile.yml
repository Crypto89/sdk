---
- hosts: localhost
  connection: local
  vars:
    controller: "{{ controller }}"
    username: "{{ username }}"
    password: "{{ password }}"
    pool_name: "{{ pool_name }}"
    pool_servers: "{{ pool_servers }}"
    servers: servers
    enabled: "{{ enabled }}"
    state: "{{ state }}"
  tasks:
  - name: build server list
    set_fact:
      servers_list: "{{servers_list|default([]) + [{'ip': {'addr': item, 'type': 'V4'}, 'enabled': enabled | bool}] }}"
    with_items: "{{pool_servers.split(',')}}"
    # each server_list item has ansible fact as server
  - block:
    - name: Create Pool with persistency profile
      avi_pool:
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        name: "{{ pool_name }}"
        api_version: "{{api_version}}"
        description: test pool
        health_monitor_refs:
           - '/api/healthmonitor?name=System-HTTP'
        servers: "{{ servers_list }}"
        default_server_port: 80
        application_persistence_profile_ref: '/api/applicationpersistenceprofile?name=System-Persistence-Http-Cookie'
      register: mypool
    - fail: msg=pool "{{ pool_name }}" creation failed
      when:
        - "'uuid' not in mypool.obj"
    - name: Get Pool with persistency profile
      avi_api_session:
        # get pool information
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        http_method: get
        path: "pool/{{ mypool.obj.uuid }}"
        api_version: "{{api_version}}"
      register: rsp
    - fail: msg="pool not {{ pool_name }} present"
      when:
        - "rsp.obj.application_persistence_profile_ref == ''"
    when: state == "present"
  - block:
    - name: Delete Pool
      avi_pool:
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        name: "{{ pool_name }}"
        description: test pool
        api_version: "{{api_version}}"
        health_monitor_refs:
           - '/api/healthmonitor?name=System-HTTP'
        servers: "{{ servers_list }}"
        application_persistence_profile_ref:
            state: absent
      register: mypool
    - name: Delete pool
      avi_pool:
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        name: "{{ pool_name }}"
        api_version: "{{api_version}}"
        description: test pool
        health_monitor_refs:
           - '/api/healthmonitor?name=System-HTTP'
        servers: "{{ servers_list }}"
        application_persistence_profile_ref: ''
      register: mypool2
    - name: Delete pool again using api_session
      avi_api_session:
        # get pool information
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        http_method: get
        path: pool
        params:
          name: "{{ pool_name }}"
        api_version: "{{api_version}}"
      register: rsp
    - fail: msg="pool {{ pool_name }} pers profile present"
      when: rsp.obj.application_persistence_profile_ref is defined
    when: state == "absent"
