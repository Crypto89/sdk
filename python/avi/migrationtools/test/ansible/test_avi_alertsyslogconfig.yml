---
- hosts: localhost
  connection: local

  vars:
    avi_credentials:
      controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
      username: "{{ lookup('env', 'AVI_USERNAME') }}"
      password: "{{ lookup('env', 'AVI_PASSWORD') }}"
      api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk

  tasks:
  - block:
    - name: Create systemlog object
      avi_alertsyslogconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        name: test
        tenant_ref: '/api/tenant/?name=admin'
        syslog_servers:
        - udp: true
          syslog_server_port: 443
          syslog_server: 10.10.3.10
      register: result

    - name: Update systemlog object
      avi_alertsyslogconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        avi_api_update_method: put
        name: updated-test-log
        tenant_ref: '/api/tenant/?name=admin'
        uuid: "{{result.obj.uuid}}"
        syslog_servers:
        - udp: true
          syslog_server_port: 80
          syslog_server: 10.10.20.12
      register: updated_result

    - name: Update systemlog using patch
      avi_alertsyslogconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        avi_api_update_method: put
        name: updated-test-log
        tenant_ref: '/api/tenant/?name=admin'
        uuid: "{{updated_result.obj.uuid}}"
        avi_api_patch_op: add
        syslog_servers:
        - udp: true
          syslog_server_port: 80
          syslog_server: 10.10.20.12
        - udp: true
          syslog_server_port: 189
          syslog_server: 10.10.10.11
      register: delete_result

  - block:
    - name: Delete configuration
      avi_alertsyslogconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        state: absent
        name: updated-test-log
        uuid: "{{delete_result.obj.uuid}}"
      register: delete_result

    - name: check object is deleted or not
      avi_api_session:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        http_method: get
        path: alertsyslogconfig
      register: get_result
    - fail: msg="Object no deleted "
      when:
        - get_result.obj.count != 0
