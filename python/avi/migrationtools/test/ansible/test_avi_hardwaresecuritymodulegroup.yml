---
- hosts: localhost
  connection: local

  vars:
   avi_credentials:
    controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
    username: "{{ lookup('env', 'AVI_USERNAME') }}"
    password: "{{ lookup('env', 'AVI_PASSWORD') }}"
    api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create hardware security module object
        avi_hardwaresecuritymodulegroup:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: test
          tenant_ref: '/api/tenant?name=admin'
          hsm:
            rfs:
              ip:
                type: V4
                addr: 1.2.3.4
              port: 9004
            type: HSM_TYPE_THALES_NETHSM
            nethsm:
            - remote_port: 9004
              priority: 100
              keyhash: abc
              module_id: 0
              esn: '123'
              remote_ip:
                type: V4
                addr: 1.2.3.4
        register: result

      - name: Update hardware security module group name
        avi_hardwaresecuritymodulegroup:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: put
          name: updated-test
          uuid: "{{result.obj.uuid}}"
          hsm:
            rfs:
              ip:
                type: V4
                addr: 1.2.3.33
              port: 9004
            type: HSM_TYPE_THALES_NETHSM
            nethsm:
            - remote_port: 9004
              priority: 100
              keyhash: abc
              module_id: 0
              esn: '123'
              remote_ip:
                type: V4
                addr: 10.30.22.34
        register: updated_result

      - name: Delete hardware security module group object
        avi_hardwaresecuritymodulegroup:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: updated-test
          uuid: "{{updated_result.obj.uuid}}"
          state: absent
          hsm:
            rfs:
              ip:
                type: V4
                addr: 1.2.3.33
              port: 9004
            type: HSM_TYPE_THALES_NETHSM
            nethsm:
            - remote_port: 9004
              priority: 100
              keyhash: abc
              module_id: 0
              esn: '123'
              remote_ip:
                type: V4
                addr: 10.30.22.34
        register: delete_result
