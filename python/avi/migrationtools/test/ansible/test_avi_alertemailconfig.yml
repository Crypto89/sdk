---
- hosts: localhost
  connection: local

  vars:
    avi_credentials:
      controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
      username: "{{ lookup('env', 'AVI_USERNAME') }}"
      password: "{{ lookup('env', 'AVI_PASSWORD') }}"
      api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk

  tasks:
  - block:
    - name: Create email object
      avi_alertemailconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        name: test-email
        tenant_ref: "/api/tenant/?name=admin"
        to_emails: 'abc.pqx@gmail.com'
        cc_emails: 'avi.123@gmail.com'
      register: result

    - name: update email object
      avi_alertemailconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        name: updated-test-email
        tenant_ref: "/api/tenant/?name=admin"
        to_emails: 'test.pqx@gmail.com'
        cc_emails: ''
        avi_api_update_method: put
        uuid: "{{result.obj.uuid}}"
      register: updated_result

    - name: Delete email object
      avi_alertemailconfig:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        name: updated-test-email
        to_emails: 'test.pqx@gmail.com'
        uuid: "{{updated_result.obj.uuid}}"
        state: absent
      register: del_result

    - name: check config deleted or not
      avi_api_session:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        path: alertemailconfig
        http_method: get
      register: verify_delete
    - fail: msg="Object not deleted"
      when:
        - verify_delete.obj.count != 0
