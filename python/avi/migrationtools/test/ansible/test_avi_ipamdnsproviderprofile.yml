---
- hosts: localhost
  connection: local

  vars_files:
    - 'avi_credentials.yml'
  vars:
   avi_credentials:
  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create ipamdnsproviderprofile object
        avi_ipamdnsproviderprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: test
          tenant_ref: /api/tenant?name=admin
          internal_profile:
            dns_service_domain:
            - record_ttl: 150
              num_dns_ip: 1
              domain_name: rohan
              pass_through: true
            ttl: 30
          type: IPAMDNS_TYPE_INTERNAL_DNS
        register: result

      - name: Update ipamdnsproviderprofile object
        avi_ipamdnsproviderprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: test
          tenant_ref: /api/tenant?name=admin
          avi_api_update_method: put
          internal_profile:
            dns_service_domain:
            - record_ttl: 150
              num_dns_ip: 1
              domain_name: rohan
              pass_through: true
            - record_ttl: 120
              num_dns_ip: 2
              domain_name: rohan.local
              pass_through: true
            ttl: 30
          type: IPAMDNS_TYPE_INTERNAL_DNS
        register: updated_result

      - name: Delete ipamdnsproviderprofile object
        avi_ipamdnsproviderprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: test
          type: IPAMDNS_TYPE_INTERNAL_DNS
          state: absent
