---
- hosts: localhost
  connection: local

  vars:
   avi_credentials:
      controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
      username: "{{ lookup('env', 'AVI_USERNAME') }}"
      password: "{{ lookup('env', 'AVI_PASSWORD') }}"
      api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create errorpageprofile object
        avi_errorpageprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: present
          name: profile-1
          tenant_ref: '/api/tenant?name=admin'
          host_name: 'admin'
          company_name: 'test-company'
          app_name: 'Demo-app'
        register: result

      - name: Updated errorpageprofile object
        avi_errorpageprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: patch
          avi_api_patch_op: replace
          uuid: "{{result.obj.uuid}}"
          name: profile-1
          company_name: 'test-company'
          app_name: 'Demo-application'
        register: replace_result

      - name: Delete errorpageprofile object
        avi_errorpageprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: 'absent'
          uuid: "{{replace_result.obj.uuid}}"
          name: profile-1
        register: delete_result

      - name: Create errorpageprofile object using by check mode
        avi_errorpageprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: present
          name: profile-1
          tenant_ref: '/api/tenant?name=admin'
          host_name: 'admin'
          company_name: 'test-company'
          app_name: 'Demo-app'
        register: mode_result
        check_mode: true

      - name: Delete non existing errorpageprofile object
        avi_errorpageprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: 'absent'
          name: profile-2
        register: del_obj_result
