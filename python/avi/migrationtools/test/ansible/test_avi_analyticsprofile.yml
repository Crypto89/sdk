---
- hosts: localhost
  connection: local

  vars_files:
    - "avi_credentials.yml"
  vars:
    avi_credentials:

  roles:
    - role: avinetworks.avisdk

  tasks:
    - block:
      - name: Create analytics profile object
        avi_analyticsprofile:
          name: Test-System-Analytics-Profile
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          tenant_ref: "/api/tenant/?name=admin"
          hs_event_throttle_window: 1209600
          description: Test System Analytics Profile
          apdex_response_threshold: 500
          disable_se_analytics: false
          apdex_server_rtt_tolerated_factor: 4
          hs_security_nonpfs_penalty: 1
          hs_security_tls12_score: 5
          exclude_server_tcp_reset_as_error: false
          hs_min_dos_rate: 1000
          exclude_no_dns_record_as_error: false
          conn_server_lossy_zero_win_size_event_threshold: 2
          hs_max_resources_penalty: 25
          conn_lossy_total_rexmt_threshold: 50
          hs_pscore_traffic_threshold_l4_client: 10
          exclude_no_valid_gs_member_as_error: false
          apdex_server_response_threshold: 400
          hs_security_cipherscore_ge128b: 5
          hs_performance_boost: 0
          exclude_invalid_dns_domain_as_error: false
          exclude_http_error_codes:
          - 475
          hs_max_anomaly_penalty: 10
          hs_security_tls11_score: 5
          exclude_gs_down_as_error: false
          apdex_server_response_tolerated_factor: 4
          disable_server_analytics: false
          conn_server_lossy_timeo_rexmt_threshold: 20
          exclude_client_close_before_request_as_error: true
          hs_security_weak_signature_algo_penalty: 1
          exclude_persistence_change_as_error: false
          hs_security_selfsignedcert_penalty: 1
          conn_server_lossy_total_rexmt_threshold: 50
          conn_lossy_timeo_rexmt_threshold: 20
          conn_lossy_ooo_threshold: 50
          apdex_rtt_tolerated_factor: 4
          hs_security_certscore_gt30d: 5
          hs_security_ssl30_score: 3.5
          conn_server_lossy_ooo_threshold: 50
          apdex_rum_tolerated_factor: 4
          hs_security_cipherscore_eq000b: 0
          hs_security_certscore_le30d: 4
          hs_pscore_traffic_threshold_l4_server: 10
          exclude_syn_retransmit_as_error: false
          apdex_server_rtt_threshold: 125
          hs_security_hsts_penalty: 1
          exclude_server_dns_error_as_error: false
          hs_security_certscore_le07d: 2
          conn_lossy_zero_win_size_event_threshold: 2
          hs_security_encalgo_score_rc4: 2.5
          hs_max_security_penalty: 100
          exclude_tcp_reset_as_error: false
          hs_security_encalgo_score_none: 0
          apdex_response_tolerated_factor: 4
          client_log_config:
            enable_significant_log_collection: true
            significant_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
            non_significant_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
            filtered_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
          hs_security_chain_invalidity_penalty: 1
          exclude_invalid_dns_query_as_error: false
          apdex_rum_threshold: 5000
          hs_security_cipherscore_lt128b: 3.5
          hs_security_tls10_score: 5
          hs_security_certscore_expired: 0
          apdex_rtt_threshold: 250
          exclude_unsupported_dns_query_as_error: false
        register: result

      - name: Updated analytics profile object
        avi_analyticsprofile:
          name: Updated-System-Analytics-Profile
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          tenant_ref: "/api/tenant/?name=admin"
          hs_event_throttle_window: 1209600
          description: Updated System Analytics Profile
          apdex_response_threshold: 500
          disable_se_analytics: false
          apdex_server_rtt_tolerated_factor: 5
          hs_security_nonpfs_penalty: 1
          hs_security_tls12_score: 5
          exclude_server_tcp_reset_as_error: false
          hs_min_dos_rate: 800
          exclude_no_dns_record_as_error: false
          conn_server_lossy_zero_win_size_event_threshold: 2
          hs_max_resources_penalty: 25
          conn_lossy_total_rexmt_threshold: 50
          hs_pscore_traffic_threshold_l4_client: 10
          exclude_no_valid_gs_member_as_error: false
          apdex_server_response_threshold: 400
          hs_security_cipherscore_ge128b: 5
          hs_performance_boost: 0
          exclude_invalid_dns_domain_as_error: true
          exclude_http_error_codes:
          - 475
          hs_max_anomaly_penalty: 10
          hs_security_tls11_score: 5
          exclude_gs_down_as_error: false
          apdex_server_response_tolerated_factor: 3
          disable_server_analytics: false
          conn_server_lossy_timeo_rexmt_threshold: 20
          exclude_client_close_before_request_as_error: true
          hs_security_weak_signature_algo_penalty: 1
          exclude_persistence_change_as_error: false
          hs_security_selfsignedcert_penalty: 1
          conn_server_lossy_total_rexmt_threshold: 50
          conn_lossy_timeo_rexmt_threshold: 20
          conn_lossy_ooo_threshold: 50
          apdex_rtt_tolerated_factor: 2
          hs_security_certscore_gt30d: 5
          hs_security_ssl30_score: 3.5
          conn_server_lossy_ooo_threshold: 50
          apdex_rum_tolerated_factor: 6
          hs_security_cipherscore_eq000b: 0
          hs_security_certscore_le30d: 4
          hs_pscore_traffic_threshold_l4_server: 10
          exclude_syn_retransmit_as_error: false
          apdex_server_rtt_threshold: 125
          hs_security_hsts_penalty: 1
          exclude_server_dns_error_as_error: false
          hs_security_certscore_le07d: 2
          conn_lossy_zero_win_size_event_threshold: 2
          hs_security_encalgo_score_rc4: 2.5
          hs_max_security_penalty: 100
          exclude_tcp_reset_as_error: false
          hs_security_encalgo_score_none: 0
          apdex_response_tolerated_factor: 4
          client_log_config:
            enable_significant_log_collection: true
            significant_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
            non_significant_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
            filtered_log_processing: LOGS_PROCESSING_SYNC_AND_INDEX_ON_DEMAND
          hs_security_chain_invalidity_penalty: 1
          exclude_invalid_dns_query_as_error: false
          apdex_rum_threshold: 7000
          hs_security_cipherscore_lt128b: 4.5
          hs_security_tls10_score: 5
          hs_security_certscore_expired: 0
          apdex_rtt_threshold: 500
          exclude_unsupported_dns_query_as_error: false
          avi_api_update_method: put
          uuid: "{{result.obj.uuid}}"
        register: updated_result

      - name: Delete analytic profile object
        avi_analyticsprofile:
          name: Updated-System-Analytics-Profile
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          uuid: "{{updated_result.obj.uuid}}"
          state: 'absent'
        register: delete_result

