---
- hosts: localhost
  connection: local

  vars:
    avi_credentials:
      controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
      username: "{{ lookup('env', 'AVI_USERNAME') }}"
      password: "{{ lookup('env', 'AVI_PASSWORD') }}"
      api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: get cluster object
        avi_api_session:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          http_method: get
          path: cluster
        register: result

      - name: updated cluster object
        ignore_errors: true
        avi_cluster:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: put
          nodes:
          - ip:
              type: V4
              addr: 10.10.26.6
            vm_hostname: node1.controller.local
            vm_uuid: 005056b0481e
            name: 10.10.26.166
            vm_mor: vm-199911
          tenant_uuid: admin
          uuid: "{{result.obj.uuid}}"
          name: cluster-0-1
          rejoin_nodes_automatically: true