---
- hosts: localhost
  connection: local
  vars_files:
    - 'avi_credentials.yml'
  vars:
   avi_credentials:

  roles:
    - role: avinetworks.avisdk
  tasks:

    - block:
      - name: Create virtual service
        avi_virtualservice:
          api_version: 17.2.5
          cloud_ref: /api/cloud?name=Default-Cloud
          controller: "{{ avi_credentials.controller }}"
          enabled: false
          name: 'test-vs1'
          password: "{{ avi_credentials.password }}"
          state: 'present'
          services:
            - enable_ssl: true
              port: '443'
          tenant: admin
          tenant_ref: /api/tenant/?name=admin
          type: VS_TYPE_NORMAL
          username: "{{ avi_credentials.username }}"
          vip:
            - ip_address:
                addr: 172.82.10.1
                type: V4
              vip_id: 0
        register: test_result
      - fail: msg="virtual service is not created"
        when:
            - "'uuid' not in test_result.obj"

      - name: Create application profile
        avi_application:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: 'Test-Application-profile'
          state: 'present'
          virtualservice_refs:
          - '/api/virtualservice?name=test-vs1'
        register: result
      - fail: msg="Application profile not created"
        when: "'uuid' not in result.obj"

    - block:
      - name: Update Application profile
        avi_application:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: 'Updated-Application-profile'
          state: 'present'
          uuid: '{{result.obj.uuid}}'
        register: update_result
      - fail: msg="Update failed"
        when:
          - "'uuid' not in update_result.obj"
    - block:
      - name: Delete application profile
        avi_application:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: 'Updated-Application-profile'
          state: 'absent'
          uuid: '{{update_result.obj.uuid}}'

      - name: Delete virtual service
        avi_virtualservice:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: 'test-vs1'
          state: 'absent'
