---
- hosts: localhost
  connection: local

  vars_files:
    - 'avi_credentials.yml'
  vars:
   avi_credentials:
  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create alertscriptconfig object
        avi_alertscriptconfig:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: test
          tenant_ref: /api/tenant?name=admin
          action_script: echo "avi networks"
        register: result

      - name: Update alertscriptconfig object
        avi_alertscriptconfig:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: updated-test
          action_script: "ls"
          avi_api_update_method: put
          uuid: "{{result.obj.uuid}}"
        register: updated_result

    - block:
      - name: Destroy alert script object
        avi_alertscriptconfig:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          name: updated-test
          state: absent
        register: deleted_result

      - name: check object is deleted or not
        avi_api_session:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          http_method: get
          path: alertscriptconfig
        register: get_result
      - fail: msg="Object deletion faild"
        when:
          - get_result.obj.count != 0


