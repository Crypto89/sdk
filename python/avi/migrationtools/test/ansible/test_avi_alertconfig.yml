---
- hosts: localhost
  connection: local
  vars_files:
    - 'avi_credentials.yml'
  vars:
   avi_credentials:

  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create alert config object
        avi_alertconfig:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          name: Test-System-SSL-Alert
          enabled: true
          tenant_ref: "/api/tenant/?name=admin"
          category: REALTIME
          expiry_time: 86400
          summary: System-SSL-Alert System Alert Triggered
          rolling_window: 300
          source: EVENT_LOGS
          alert_rule:
            operator: OPERATOR_OR
            sys_event_rule:
            - event_id: SSL_CERT_EXPIRE
              not_cond: false
            - event_id: SSL_CERT_RENEW
              not_cond: false
            - event_id: SSL_CERT_RENEW_FAILED
              not_cond: false
          threshold: 1
          throttle: 0
          action_group_ref: "/api/actiongroupconfig/?name=System-Alert-Level-Medium"
        register: result

      - name: Update alert config object
        avi_alertconfig:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: put
          name: Updated-System-SSL-Alert
          enabled: true
          tenant_ref: "/api/tenant/?name=admin"
          category: ROLLINGWINDOW
          expiry_time: 72400
          summary: System-SSL-Alert System Alert Triggered
          rolling_window: 300
          source: EVENT_LOGS
          description: updated desc
          uuid: "{{result.obj.uuid}}"
          alert_rule:
            operator: OPERATOR_OR
            sys_event_rule:
            - event_id: SSL_CERT_EXPIRE
              not_cond: false
            - event_id: SSL_CERT_RENEW
              not_cond: false
            - event_id: SSL_CERT_RENEW_FAILED
              not_cond: false
          threshold: 14
          throttle: 100
          action_group_ref: "/api/actiongroupconfig/?name=System-Alert-Level-High"
        register: updated_result

      - name: Delete alert config object
        avi_alertconfig:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          state: absent
          uuid: "{{updated_result.obj.uuid}}"
          name: Updated-System-SSL-Alert
          source: EVENT_LOGS
          category: ROLLINGWINDOW
          alert_rule:
            operator: OPERATOR_OR
            sys_event_rule:
            - event_id: SSL_CERT_EXPIRE
              not_cond: false
            - event_id: SSL_CERT_RENEW
              not_cond: false
            - event_id: SSL_CERT_RENEW_FAILED
              not_cond: false