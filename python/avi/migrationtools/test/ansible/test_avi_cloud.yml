---
- hosts: localhost
  connection: local
  vars:
   avi_credentials:
    controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
    username: "{{ lookup('env', 'AVI_USERNAME') }}"
    password: "{{ lookup('env', 'AVI_PASSWORD') }}"
    api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk
  tasks:
    - block:
      - name: Create cloud
        avi_cloud:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          name: Test-Vcenter-Cloud
          tenant_ref: '/api/tenant?name=admin'
          dhcp_enabled: true
          enable_vip_static_routes: false
          license_type: LIC_CORES
          mtu: 1500
          prefer_static_routes: false
          vcenter_configuration:
            datacenter: "Demo-DC"
            management_network: api/vimgrnwruntime/dvportgroup-102-10.128.2.190
            password: vmware
            privilege: WRITE_ACCESS
            username: root
            vcenter_url: 10.128.2.190
          vtype: CLOUD_VCENTER
        register: result

      - name: Get cloud information
        avi_api_session:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          http_method: get
          path: cloud?name=Test-Vcenter-Cloud
        register: get_result

      - name: update cloud details
        avi_cloud:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: put
          uuid: "{{result.obj.uuid}}"
          name: Updated-Vcenter-Cloud
          tenant_ref: '/api/tenant?name=admin'
          dhcp_enabled: true
          enable_vip_static_routes: true
          enable_vip_static_routes: true
          vcenter_configuration:
            enter_configuration:
            datacenter: "Demo-DC"
            management_network: api/vimgrnwruntime/dvportgroup-102-10.128.2.190
            password: vmware
            privilege: READ_ACCESS
            username: root
            vcenter_url: 10.128.2.190
          vtype: CLOUD_VCENTER

      - name: delete cloud using avi_api_update_method
        avi_cloud:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{avi_credentials.api_version}}"
          uuid: "{{result.obj.uuid}}"
          avi_api_update_method: put
          state: 'absent'
          name: Updated-Vcenter-Cloud
          vtype: CLOUD_VCENTER
        register: updated_result

