---
- hosts: localhost
  connection: local

  vars:
   avi_credentials:
    controller: "{{ lookup('env', 'AVI_CONTROLLER') }}"
    username: "{{ lookup('env', 'AVI_USERNAME') }}"
    password: "{{ lookup('env', 'AVI_PASSWORD') }}"
    api_version: "{{ lookup('env', 'API_VERSION') }}"

  roles:
    - role: avinetworks.avisdk
  tasks:
  - block:
    - name: get cluster object
      avi_api_session:
        controller: "{{ avi_credentials.controller }}"
        username: "{{ avi_credentials.username }}"
        password: "{{ avi_credentials.password }}"
        api_version: "{{ avi_credentials.api_version }}"
        path: cluster
        http_method: get
        params:
          name: cluster-0-1
      register: get_result
    - name: Create gslb object
      avi_gslb:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{ avi_credentials.api_version }}"
          name: Default
          tenant_ref: admin
          maintenance_mode: false
          view_id: 0
          sites:
          - username: admin
            name: Test1
            ip_addresses:
            - type: V4
              addr: "{{ avi_credentials.controller }}"
            enabled: true
            member_type: GSLB_ACTIVE_MEMBER
            location:
              source: GSLB_LOCATION_SRC_USER_CONFIGURED
              location:
                latitude: 18.520429611206055
                tag: Pune
                name: pune
                longitude: 73.85674285888672
            cluster_uuid: "{{get_result.obj.uuid}}"
            password: "{{avi_credentials.password}}"
            port: 443
          client_ip_addr_group:
            type: GSLB_IP_PUBLIC
          send_interval: 15
          dns_configs:
          - domain_name: com
          is_federated: true
          leader_cluster_uuid: "{{get_result.obj.uuid}}"
          clear_on_max_retries: 20
      register: gslb_result

    - block:
      - name: Create pkiprofile object
        avi_pkiprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: 'present'
          name: test-pkiprofile
          tenant_ref: '/api/tenant?name=admin'
          is_federated: true
          ignore_peer_chain: false
          crl_check: true
        register: result

      - name: Update pkiprofile object
        avi_pkiprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          avi_api_update_method: put
          uuid: "{{result.obj.uuid}}"
          url: '/api/pkiprofile'
          name: updated-pkiprofile
          is_federated: true
          ignore_peer_chain: true
          crl_check: false
        register: updated_result

      - name: Delete pkiprofile object
        avi_pkiprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: 'absent'
          uuid: "{{result.obj.uuid}}"
          name: updated-pkiprofile

      - name: Delete nonexisting pkiprofile object
        avi_pkiprofile:
          username: "{{avi_credentials.username}}"
          password: "{{avi_credentials.password}}"
          controller: "{{avi_credentials.controller}}"
          api_version: "{{avi_credentials.api_version}}"
          state: 'absent'
          url: '/api/pkiprofile'
          name: nonexitobj
        check_mode: true

      - name: Delete gslb object
        avi_gslb:
          controller: "{{ avi_credentials.controller }}"
          username: "{{ avi_credentials.username }}"
          password: "{{ avi_credentials.password }}"
          api_version: "{{ avi_credentials.api_version }}"
          state: absent
          name: Default
          leader_cluster_uuid: "{{gslb_result.obj.uuid}}"